import telebot
import requests
import time
import re
import threading
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

TOKEN = '7455891372:AAFA2Qob9RAvxjOyPPG6O-SRXc5k-Z7b-BQ'
bot = telebot.TeleBot(TOKEN)

# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ø±Ù‚Ù…
allowed_any_number_users = [5211520354, 5814912767, 6507847901, 6169029930, 5101721659, 5437138094]

# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ù…
allowed_users = [5211520354, 5814912767]

# Ù‚Ø§Ø¦Ù…Ø© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§
allowed_phones = ['0551234567', '0557654321']

# Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø´Ø®ØµÙŠ
global_access_token = None
global_phone_number = None

# Ù‚Ø§Ø¦Ù…Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
registered_numbers = []

def is_user_allowed(user_id):
    return user_id in allowed_any_number_users or user_id in allowed_users

def is_phone_allowed(user_id, phone_number):
    if user_id in allowed_any_number_users:
        return True
    elif user_id in allowed_users:
        return phone_number in allowed_phones
    return False

def delete_message(chat_id, message_id, delay):
    time.sleep(delay)
    bot.delete_message(chat_id, message_id)

def send_welcome(message):
    bot.reply_to(message, "Ø£Ù†Øª ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ ÙÙŠ Ø¨ÙˆØª Ù„Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ @imthebest997")

@bot.message_handler(commands=['start', 'help'])
def start(message):
    send_welcome(message)

@bot.message_handler(func=lambda message: re.fullmatch(r'05\d{8}', message.text))
def handle_phone_number(message):
    global global_phone_number
    global_phone_number = message.text
    user_id = message.from_user.id
    if is_user_allowed(user_id):
        if is_phone_allowed(user_id, global_phone_number):
            if global_phone_number in registered_numbers:
                bot.send_message(message.chat.id, "Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.")
                send_final_request(message, global_access_token, global_phone_number)
            else:
                send_verification_code(message, global_phone_number)
        else:
            bot.send_message(message.chat.id, "Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡.")
    else:
        bot.send_message(message.chat.id, "Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„Ø§ ÙŠØ³Ù…Ø­ Ù„Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª.")

def send_verification_code(message, phone_number):
    url = "https://ibiza.ooredoo.dz/auth/realms/ibiza/protocol/openid-connect/token"
    payload = {
        "client_id": "ibiza-app",
        "grant_type": "password",
        "mobile-number": phone_number,
        "language": "AR"
    }
    headers = {
        "User-Agent": "okhttp/4.9.3",
        "Connection": "Keep-Alive",
        "Accept-Encoding": "gzip",
        "Content-Type": "application/x-www-form-urlencoded"
    }
    response = requests.post(url, data=payload, headers=headers)
    if "ROOGY" in response.text:
        bot.send_message(message.chat.id, "ğŸ’¬ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­ âœ… ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø® Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø°ÙŠ ØªÙ„Ù‚ÙŠØªÙ‡ ÙÙŠ Ø±Ø³Ø§Ù„Ø© ğŸ’¬ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ ğŸ“±")
        msg = bot.send_message(message.chat.id, "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²:")
        msg = bot.send_message(message.chat.id, "ğŸ’¬")
        bot.register_next_step_handler(msg, verify_code, phone_number)
    else:
        bot.send_message(message.chat.id, "ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø². Ø§Ù†ØªØ¸Ø± Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ğŸ•œ.")

def verify_code(message, phone_number):
    global global_access_token
    otp_code = message.text
    url = "https://ibiza.ooredoo.dz/auth/realms/ibiza/protocol/openid-connect/token"
    payload = {
        "client_id": "ibiza-app",
        "grant_type": "password",
        "mobile-number": phone_number,
        "language": "AR",
        "otp": otp_code
    }
    headers = {
        "User-Agent": "okhttp/4.9.3",
        "Connection": "Keep-Alive",
        "Accept-Encoding": "gzip",
        "Content-Type": "application/x-www-form-urlencoded"
    }
    response = requests.post(url, data=payload, headers=headers)
    response_json = response.json()
    if "access_token" in response_json:
        global_access_token = response_json["access_token"]
        registered_numbers.append(phone_number)
        bot.send_message(message.chat.id, "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø² âœ… Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø­ÙÙˆØ¸.")
        send_final_request(message, global_access_token, phone_number)
    else:
        bot.send_message(message.chat.id, "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ğŸ’¬.")

def send_final_request(message, access_token, phone_number):
    url = 'https://ibiza.ooredoo.dz/api/v1/mobile-bff/users/mgm/info/apply'
    headers = {
        'Authorization': f'Bearer {access_token}',
        'language': 'AR',
        'request-id': 'ed66ca07-7aee-4b97-952c-f0fcbc7eee0f',
        'flavour-type': 'gms',
        'Content-Type': 'application/json; charset=utf-8',
        'Host': 'ibiza.ooredoo.dz',
        'Connection': 'Keep-Alive',
        'User-Agent': 'okhttp/4.9.3',
    }

    data = '{"skipMgm":false,"mgmValue":"0558494790"}'

    for _ in range(5):
        response = requests.post(url, headers=headers, data=data)
        wait_message = bot.send_message(message.chat.id, "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ğŸ””")
        threading.Thread(target=delete_message, args=(message.chat.id, wait_message.message_id, 1)).start()
        time.sleep(1)

    balance = check_balance(access_token)
    if balance is not None:
        bot.send_message(message.chat.id, f"ğŸ‰")
        bot.send_message(message.chat.id, f"Ø­Ù€Ø¬Ù… Ø§Ù„Ø£Ù†Ù€ØªØ±Ù†Ù€Øª Ø§Ù„Ø£Ù† Ù‡ÙˆğŸ’µ : {balance}")
    else:
        bot.send_message(message.chat.id, "ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø±ØµÙŠØ¯.")

def check_balance(access_token):
    url = "https://ibiza.ooredoo.dz/api/v1/mobile-bff/users/balance"
    
    headers = {
        'Authorization': f'Bearer {access_token}',
        'User-Agent': "okhttp/4.9.3",
        'Connection': "Keep-Alive",
        'Accept-Encoding': "gzip",
        'language': "AR",
        'request-id': "995fd8a7-853c-481d-b9c6-0a24295df76a",
        'flavour-type': "gms"
    }

    response = requests.get(url, headers=headers)
    response_json = response.json()

    accounts = response_json.get('accounts', [])

    for account in accounts:
        if account.get('label') == 'Ø±ØµÙŠØ¯ Ø§Ù„ØªÙƒÙÙ„ Ø§Ù„Ù…Ù‡Ø¯Ù‰':
            return account.get('value', None)
    return None

while True:
    try:
        bot.polling(none_stop=True, interval=0, timeout=20)
    except Exception as e:
        print(f"Error: {e}")
        time.sleep(15)
